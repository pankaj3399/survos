given:

cache:
  - db: no-key.csv
    steps:
      - operation: has
        key: nj
        expects: false

  - db: key-no-in-headers.csv
    headers: [label]

    steps:
      - operation: set
        data: {"Id Number": 'nj', label: 'New Jersey'}
        csv: |
          id_number,label
          nj,"New Jersey"

      - operation: getKeyName
        expects: id_number

      - operation: getKeyAlias
        expects: "Id Number"

    # set with key
      - operation: set
        key: va
        data: {label: 'Virginia'}
        csv: |
          code,label
          nj,"New Jersey"
          va,Virginia

      - operation: set
        data: {code: oh, label: 'Ohio'}
        csv: |
          code,label
          nj,"New Jersey"
          va,Virginia
          oh,Ohio

  - db: movie.csv
    key: code
    headers: [code,label]

    steps:
      - operation: has
        key: nj
        expects: false

  - db: key-no-in-headers.csv
    key: code
    headers: [label]

    steps:
      - operation: set
        key: nj
        data: {code: 'nj', label: 'New Jersey'}
        csv: |
          code,label
          nj,"New Jersey"

      - operation: set
        key: va
        data: {label: 'Virginia'}
        csv: |
          code,label
          nj,"New Jersey"
          va,Virginia

  - db: no-headers-provided.csv
    key: code

    steps:
      - operation: set
        key: nj
        data: {label: 'New Jersey'}
        csv: |
          code,label
          nj,"New Jersey"

      - operation: has
        key: nj
        expect: true

      - operation: set
        key: oh
        data: {code: 'oh', label: 'Ohio'}
        csv: |
          code,label
          nj,"New Jersey"
          oh,Ohio

      - operation: set
        key: va
        data: {label: 'Virginia'}
        csv: |
          code,label
          nj,"New Jersey"
          oh,Ohio
          va,Virginia

  - db: movie.csv
    key: code
    headers: [code,label]

    steps:
      - operation: has
        key: code
        expects: false

      - operation: set
        key: nj
        data: {code: 'nj', label: 'New Jersey'}
        csv: |
          code,label
          nj,"New Jersey"

      - operation: has
        key: nj
        expects: true

      - operation: set
        key: va
        data: {code: 'va', label: 'Virginia'}
        csv: |
          code,label
          nj,"New Jersey"
          va,Virginia

      - operation: set
        key: oh
        data: {code: 'oh', label: 'Ohoi'}
        csv: |
          code,label
          nj,"New Jersey"
          va,Virginia
          oh,Ohoi

      - operation: set
        key: ma
        data: {code: 'ma', label: 'Maine'}
        csv: |
          code,label
          nj,"New Jersey"
          va,Virginia
          oh,Ohoi
          ma,Maine

      - operation: replace
        key: oh
        data: {code: 'oh', label: 'Ohio'}
        csv: |
          code,label
          nj,"New Jersey"
          va,Virginia
          oh,Ohio
          ma,Maine

      - operation: delete
        key: nj
        csv: |
          code,label
          va,Virginia
          oh,Ohio
          ma,Maine

#      - operation: add_headers
#        headers: [population, user_count]
#        csv: |
#          code,label,population,user_count
#          va,Virginia,,
#          oh,Ohio,,
#          ma,Maine,,
